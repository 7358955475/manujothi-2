# Enhanced Nginx Security Configuration for MANUJOTHI Media Library

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=media:10m rate=20r/s;

# IP blacklist map (can be dynamically updated)
geo $blocked_ip {
    default 0;
    # Add blocked IPs here
    # 192.168.1.100 1;
}

server {
    listen 80;
    server_name localhost;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name localhost;

    # Enhanced SSL Configuration
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Enhanced Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; media-src 'self'; connect-src 'self'; font-src 'self'; frame-src 'none';" always;
    
    # Block known bad IPs
    if ($blocked_ip) {
        return 403;
    }
    
    # Hide server information
    server_tokens off;
    
    # Request size limits
    client_max_body_size 10M;
    client_body_timeout 30s;
    client_header_timeout 30s;
    
    # Buffer overflow protection
    large_client_header_buffers 2 1k;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    
    # API routes with enhanced rate limiting
    location /api/auth/ {
        limit_req zone=auth burst=10 nodelay;
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Additional security for auth endpoints
        proxy_hide_header X-Powered-By;
        proxy_set_header X-Request-ID $request_id;
    }
    
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
    
    # Media file serving with access control
    location /uploads/ {
        limit_req zone=media burst=30 nodelay;
        
        # Secure media serving
        root /app/backend;
        
        # Only allow authenticated requests for media files
        auth_request /auth-check;
        
        # Content-Type protection
        location ~* \.(mp3|wav|m4a|ogg)$ {
            add_header Content-Type "audio/mpeg";
            add_header X-Content-Type-Options "nosniff";
            expires 1h;
        }
        
        location ~* \.(pdf)$ {
            add_header Content-Type "application/pdf";
            add_header X-Content-Type-Options "nosniff";
            expires 1h;
        }
    }
    
    # Auth check endpoint for media access
    location = /auth-check {
        internal;
        proxy_pass http://localhost:3001/api/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }
    
    # Security monitoring endpoint
    location /security/ {
        allow 127.0.0.1;
        allow ::1;
        deny all;
        
        proxy_pass http://localhost:3001/api/security/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ /(\.htaccess|\.htpasswd|\.env|config\.json) {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Logging configuration for security monitoring
error_log /var/log/nginx/manujothi_error.log warn;
access_log /var/log/nginx/manujothi_access.log combined;

# Additional security logging
log_format security '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   '"$request_time" "$upstream_response_time"';
                   
access_log /var/log/nginx/manujothi_security.log security;